const express = require('express')
const request = require('request');
const requestPromise = require('util').promisify(request);

const app = express()
const port = 3000

const LauncherTokenGenerator = require('./lancher-token-generator.js')
const htmlIndex = require('./index.js')

require('dotenv').config()
const { POW_GAMING__OPERATOR_ID, POW_GAMING__OPERATOR_SEED, POW_GAMING__POW_SEED, POW_GAMING__PLATFORM_API } = process.env

app.get('/game/:gameId', async (req, res) => {
    const gameId = req.params.gameId
    const username = req.query.username
    const userId = username ?? 'randomUser' // generated by the operator
    const operatorId = POW_GAMING__OPERATOR_ID
    const powSeed = POW_GAMING__POW_SEED
    const operatorSeed = POW_GAMING__OPERATOR_SEED
    const launcherTokenGenerator = new LauncherTokenGenerator(operatorId, gameId, userId ,powSeed , operatorSeed)
    launcherTokenGenerator.encode()
    const { body, statusCode } = await requestPromise(`${POW_GAMING__PLATFORM_API}/launch/${launcherTokenGenerator.getLaunchToken()}?call=0`)
    if (statusCode != 200) {
      return res.end('Service unavailable');
    }
    return res.redirect(body)
})

app.get('/', async (req, res) => {
    res.end(await htmlIndex(req.query.username));
})

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`)
})