const express = require('express')
const request = require('request');
const requestPromise = require('util').promisify(request);

const app = express()
const port = 3000

require('dotenv').config()
const { POW_GAMING__GAME_LIST } = process.env

const LauncherTokenGenerator = require('./lancher-token-generator.js')

require('dotenv').config()
const { POW_GAMING__OPERATOR_CODE, POW_GAMING__CURRENCY_CODE, POW_GAMING__LANG_CODE, POW_GAMING__OPERATOR_SEED, POW_GAMING__POW_SEED, POW_GAMING__PLATFORM_API } = process.env

app.use(function(req, res, next) {
  res.header("Access-Control-Allow-Origin", "*");
  res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept");
  next();
});

app.get('/game/:gameId', async (req, res) => {
    // unique user identifier from the operators's database
    const username = req.query.username
    const userId = username ?? 'randomUser' // generated by the operator
    // game_id from the gameList
    const gameId = req.params.gameId
    // authorization settings
    const api = POW_GAMING__PLATFORM_API
    const operatorCode = POW_GAMING__OPERATOR_CODE
    const powSeed = POW_GAMING__POW_SEED
    const operatorSeed = POW_GAMING__OPERATOR_SEED
    // configurable settings
    const currencyCode = POW_GAMING__CURRENCY_CODE
    const langCode = POW_GAMING__LANG_CODE
    // launcher instance
    const launcher = new LauncherTokenGenerator(api, operatorCode, currencyCode, langCode, gameId, userId ,powSeed , operatorSeed)

    async function callService() {
      const { body, statusCode } = await requestPromise(launcher.getLaunchUrl())
      return statusCode != 200 ? 'error' : body
    }
    
    for (let tries = 0; tries < 3; tries++) {
      const response = await callService()
      if (response != 'error') {
        return res.redirect(response)
      }
    }
    return res.end('Service unavailable');
})

// storing game list
app.get('/game-list.js', async (req, res) => {
  const { body } = await requestPromise(POW_GAMING__GAME_LIST)  
  return res.end(`const gamesList = ${body}`);
})

app.use(express.static('site'));

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`)
})